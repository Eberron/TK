<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
  <style>
    .success-container {
      max-width: 500px;
      margin: 50px auto;
      padding: 40px;
      text-align: center;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .success-icon {
      font-size: 64px;
      color: #10b981;
      margin-bottom: 20px;
      animation: bounce 1s ease-in-out;
    }
    
    .success-title {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 12px;
    }
    
    .success-message {
      font-size: 16px;
      color: #64748b;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .plan-info {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .plan-info h3 {
      color: #16a34a;
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    
    .plan-details {
      color: #166534;
      font-size: 14px;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #64748b;
      margin: 20px 0;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-container {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      display: none;
    }
    
    .error-title {
      color: #dc2626;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .error-message {
      color: #991b1b;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="success-container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <span>æ­£åœ¨å¤„ç†æ”¯ä»˜ç»“æœ...</span>
    </div>
    
    <!-- æˆåŠŸçŠ¶æ€ -->
    <div id="successState" style="display: none;">
      <div class="success-icon">ğŸ‰</div>
      <h1 class="success-title">æ”¯ä»˜æˆåŠŸï¼</h1>
      <p class="success-message">
        æ­å–œæ‚¨æˆåŠŸè®¢é˜…æ™ºèƒ½é¡µé¢æ€»ç»“åŠ©æ‰‹ä¸“ä¸šç‰ˆï¼<br>
        æ‚¨ç°åœ¨å¯ä»¥äº«å—æ— é™æ¬¡ä½¿ç”¨å’Œæ‰€æœ‰é«˜çº§åŠŸèƒ½ã€‚
      </p>
      
      <div id="planInfo" class="plan-info">
        <!-- è®¡åˆ’ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="openExtension()">å¼€å§‹ä½¿ç”¨</button>
        <a href="subscription.html" class="btn btn-secondary">ç®¡ç†è®¢é˜…</a>
      </div>
    </div>
    
    <!-- é”™è¯¯çŠ¶æ€ -->
    <div id="errorState" class="error-container">
      <div class="error-title">æ”¯ä»˜å¤„ç†å¤±è´¥</div>
      <div id="errorMessage" class="error-message"></div>
      <div class="action-buttons" style="margin-top: 20px;">
        <a href="subscription.html" class="btn btn-primary">é‡æ–°è®¢é˜…</a>
        <button class="btn btn-secondary" onclick="contactSupport()">è”ç³»å®¢æœ</button>
      </div>
    </div>
  </div>
  
  <script>
    // è®¢é˜…è®¡åˆ’é…ç½®
    const SUBSCRIPTION_PLANS = {
      monthly: {
        name: 'ä¸“ä¸šç‰ˆæœˆä»˜',
        price: 19,
        period: 'æ¯æœˆ',
        duration: '30å¤©'
      },
      yearly: {
        name: 'ä¸“ä¸šç‰ˆå¹´ä»˜',
        price: 199,
        period: 'æ¯å¹´',
        duration: '365å¤©'
      },
      lifetime: {
        name: 'ç»ˆèº«ä¼šå‘˜',
        price: 599,
        period: 'ç»ˆèº«',
        duration: 'æ°¸ä¹…'
      }
    };
    
    // é¡µé¢åŠ è½½æ—¶å¤„ç†æ”¯ä»˜ç»“æœ
    document.addEventListener('DOMContentLoaded', async () => {
      await handlePaymentResult();
    });
    
    // å¤„ç†æ”¯ä»˜ç»“æœ
    async function handlePaymentResult() {
      try {
        // ä»URLå‚æ•°è·å–æ”¯ä»˜ä¿¡æ¯
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');
        const status = urlParams.get('status');
        const planType = urlParams.get('plan_type');
        
        if (status === 'success' && orderId) {
          await processSuccessfulPayment(orderId, planType);
        } else if (status === 'failed') {
          showError('æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœã€‚');
        } else {
          // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–å¾…å¤„ç†è®¢å•
          const { pendingOrder } = await chrome.storage.local.get('pendingOrder');
          if (pendingOrder) {
            await processSuccessfulPayment(pendingOrder.orderId, pendingOrder.planType);
          } else {
            showError('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ”¯ä»˜ä¿¡æ¯ã€‚');
          }
        }
      } catch (error) {
        console.error('å¤„ç†æ”¯ä»˜ç»“æœå¤±è´¥:', error);
        showError('å¤„ç†æ”¯ä»˜ç»“æœæ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·è”ç³»å®¢æœã€‚');
      }
    }
    
    // å¤„ç†æˆåŠŸçš„æ”¯ä»˜
    async function processSuccessfulPayment(orderId, planType) {
      try {
        // è®¡ç®—è®¢é˜…åˆ°æœŸæ—¶é—´
        let expiryDate = null;
        if (planType === 'monthly') {
          expiryDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
        } else if (planType === 'yearly') {
          expiryDate = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000);
        }
        
        // æ›´æ–°è®¢é˜…çŠ¶æ€
        await chrome.storage.local.set({
          isPro: true,
          subscriptionPlan: planType,
          subscriptionExpiry: expiryDate ? expiryDate.getTime() : null,
          usageCount: 0, // é‡ç½®ä½¿ç”¨æ¬¡æ•°
          lastPaymentDate: Date.now(),
          orderId: orderId
        });
        
        // æ¸…é™¤å¾…å¤„ç†è®¢å•
        await chrome.storage.local.remove('pendingOrder');
        
        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        showSuccess(planType, expiryDate);
        
      } catch (error) {
        console.error('å¤„ç†è®¢é˜…æ¿€æ´»å¤±è´¥:', error);
        showError('è®¢é˜…æ¿€æ´»å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœå¤„ç†ã€‚');
      }
    }
    
    // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
    function showSuccess(planType, expiryDate) {
      const plan = SUBSCRIPTION_PLANS[planType];
      if (!plan) {
        showError('æœªçŸ¥çš„è®¢é˜…è®¡åˆ’ç±»å‹ã€‚');
        return;
      }
      
      // æ„å»ºè®¡åˆ’ä¿¡æ¯
      let expiryText = '';
      if (expiryDate && planType !== 'lifetime') {
        expiryText = `<p class="plan-details">æœ‰æ•ˆæœŸè‡³: ${expiryDate.toLocaleDateString()}</p>`;
      } else if (planType === 'lifetime') {
        expiryText = `<p class="plan-details">ç»ˆèº«æœ‰æ•ˆï¼Œäº«å—æ‰€æœ‰æœªæ¥æ›´æ–°</p>`;
      }
      
      document.getElementById('planInfo').innerHTML = `
        <h3>${plan.name}</h3>
        <p class="plan-details">è®¢é˜…è´¹ç”¨: Â¥${plan.price} (${plan.period})</p>
        ${expiryText}
        <p class="plan-details">âœ… æ— é™æ¬¡ä½¿ç”¨ âœ… é«˜çº§åŠŸèƒ½ âœ… ä¼˜å…ˆæ”¯æŒ</p>
      `;
      
      // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºæˆåŠŸçŠ¶æ€
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('successState').style.display = 'block';
    }
    
    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
    }
    
    // æ‰“å¼€æ‰©å±•
    function openExtension() {
      // å…³é—­å½“å‰æ ‡ç­¾é¡µ
      chrome.tabs.getCurrent((tab) => {
        chrome.tabs.remove(tab.id);
      });
      
      // æ‰“å¼€æ‰©å±•å¼¹çª—ï¼ˆé€šè¿‡ç‚¹å‡»æ‰©å±•å›¾æ ‡ï¼‰
      chrome.action.openPopup();
    }
    
    // è”ç³»å®¢æœ
    function contactSupport() {
      const email = 'support@example.com';
      const subject = 'æ™ºèƒ½é¡µé¢æ€»ç»“åŠ©æ‰‹ - æ”¯ä»˜é—®é¢˜å’¨è¯¢';
      const body = `æ‚¨å¥½ï¼Œæˆ‘åœ¨ä½¿ç”¨æ™ºèƒ½é¡µé¢æ€»ç»“åŠ©æ‰‹æ—¶é‡åˆ°äº†æ”¯ä»˜é—®é¢˜ï¼Œè¯·ååŠ©å¤„ç†ã€‚\n\né—®é¢˜æè¿°ï¼š\n\n\nç”¨æˆ·ä¿¡æ¯ï¼š\n- æ—¶é—´ï¼š${new Date().toLocaleString()}\n- æµè§ˆå™¨ï¼š${navigator.userAgent}`;
      
      const mailtoUrl = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailtoUrl);
    }
  </script>
</body>
</html>